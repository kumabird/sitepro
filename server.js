import express from "express";

const app = express();
app.disable("x-powered-by");

const PORT = process.env.PORT || 3000;

app.use(express.urlencoded({ extended: true }));

// ★ 叫びタイトル7種類
const titlePatterns = [
  "議員という大きな、ク、カテゴリーに比べたらア、政務調査費、セィッイッム活動費の、報告ノォォー",
  "一生懸命ほんとに、少子化問題、高齢ェェエエ者ッハアアアァアーー！！　高齢者問題はー！　我が県のみウワッハッハーーン！！　我が県のッハアーーーー！",
  "そういう問題ッヒョオッホーーー！！　解決ジダイガダメニ！　俺ハネェ！　ブフッフンハアァア！！　誰がね゛え！　誰が誰に投票ジデモ゛オンナジヤ、オンナジヤ思っでえ！",
  "ウーハッフッハーン！！　ッウーン！　ずっと投票してきたんですわ！　せやけど！　変わらへんからーそれやったらワダヂが！",
  "立候補して！　文字通り！　アハハーンッ！　命がけでイェーヒッフア゛ーー！！！　……ッウ、ック。サトウ記者！　あなたには分からないでしょうけどね！",
  "この世の中を！　ウグッブーン！！　ゴノ、ゴノ世のブッヒィフエエエーーーーンン！！　ヒィェーーッフウンン！！　ウゥ……ウゥ……。ア゛ーーーーーア゛ッア゛ーー！！！！　ゴノ！　世の！　中ガッハッハアン！！　ア゛ーー世の中を！　ゥ変エダイ！　その一心でええ！！",
  "ですから皆さまのご指摘を、県民の皆さまのご指摘と受け止めデーーヒィッフウ！！　ア゛ーハーア゛ァッハアァーー！　ッグ、ッグ、ア゛ーア゛ァアァアァ。ご指摘と受け止めて！　ア゛ーア゛ーッハア゛ーーン！"
];

// ★ 51本の固定動画（タイトルはランダム）
const fixedVideos = Array.from({ length: 51 }, () => ({
  id: "NfZsV6z48wE",
  title: titlePatterns[Math.floor(Math.random() * titlePatterns.length)]
}));

// ホーム（検索フォーム）
app.get("/", (req, res) => {
  res.send(`
    <h2>YouTube Viewer（API不要）</h2>
    <form action="/search">
      <input type="text" name="q" placeholder="検索ワードを入力" style="width:300px;">
      <button type="submit">検索</button>
    </form>
  `);
});

// ★ 検索結果（51本表示）
// → 10% の確率で wBf47hGMch0 に差し替え
// → その場合タイトルは必ず「何やってるんですか勉強してください」
app.get("/search", (req, res) => {
  const q = req.query.q;
  if (!q) return res.send("検索ワードがありません");

  let list = `
    <h2>検索結果: ${q}</h2>
    <div style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    ">
  `;

  list += fixedVideos.map(v => {
    const isSpecial = Math.random() < 0.1;
    const videoId = isSpecial ? "wBf47hGMch0" : v.id;
    const title = isSpecial
      ? "何やってるんですか勉強してください"
      : v.title;

    return `
      <div>
        <a href="/watch?v=${videoId}">
          <img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" style="width:100%; border-radius:8px;">
          <div style="margin-top:5px; font-weight:bold;">${title}</div>
        </a>
      </div>
    `;
  }).join("");

  list += "</div><br><a href='/'>戻る</a>";

  res.send(list);
});

// ★ 動画再生（9本同時）※元のまま（自動再生なし・muteなし）
app.get("/watch", (req, res) => {
  const id = req.query.v;
  if (!id) return res.send("動画IDがありません");

  const iframes = Array.from({ length: 9 }, () => `
    <iframe width="300" height="170"
      src="https://www.youtube.com/embed/${id}"
      frameborder="0" allowfullscreen></iframe>
  `).join("");

  res.send(`
    <h2>動画再生（9本同時）</h2>
    <div style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    ">
      ${iframes}
    </div>
    <br><br>
    <a href="/redirect">ホーム</a>
  `);
});

// ★ ホーム → 8秒動画 → 自動で別動画（元のまま）
app.get("/redirect", (req, res) => {
  res.send(`
    <style>
      body {
        margin: 0;
        background: black;
        overflow: hidden;
      }
      iframe {
        width: 100vw;
        height: 100vh;
        border: none;
      }
    </style>

    <iframe id="player"
      src="https://www.youtube.com/embed/mpSYaTtWlaY?autoplay=1&mute=1"
      allow="autoplay"
    ></iframe>

    <script>
      setTimeout(() => {
        document.getElementById("player").src =
          "https://www.youtube.com/embed/ZAE-avsH8D0?autoplay=1&mute=0&playlist=ZAE-avsH8D0&loop=1";
      }, 8000);
    </script>
  `);
});

app.listen(PORT, () => console.log("ですから、……皆さんのご指摘を真摯に受け止めて、議員という大きな、ク、カテゴリーに比べたらア、政務調査費、セィッイッム活動費の、報告ノォォー、ウェエ、折り合いをつけるっていうー、ことで、もう一生懸命ほんとに、少子化問題、高齢ェェエエ者ッハアアアァアーー！！　高齢者問題はー！　我が県のみウワッハッハーーン！！　我が県のッハアーーーー！　我が県ノミナラズ！　西宮みんなの、日本中の問題じゃないですか！！そういう問題ッヒョオッホーーー！！　解決ジダイガダメニ！　俺ハネェ！　ブフッフンハアァア！！　誰がね゛え！　誰が誰に投票ジデモ゛オンナジヤ、オンナジヤ思っでえ！ウーハッフッハーン！！　ッウーン！　ずっと投票してきたんですわ！　せやけど！　変わらへんからーそれやったらワダヂが！　立候補して！　文字通り！　アハハーンッ！　命がけでイェーヒッフア゛ーー！！！　……ッウ、ック。サトウ記者！　あなたには分からないでしょうけどね！　平々凡々とした、川西（市役所）を退職して、本当に、「誰が投票しても一緒や、誰が投票しても」。じゃあ俺がああ！！　立候補して！！この世の中を！　ウグッブーン！！　ゴノ、ゴノ世のブッヒィフエエエーーーーンン！！　ヒィェーーッフウンン！！　ウゥ……ウゥ……。ア゛ーーーーーア゛ッア゛ーー！！！！　ゴノ！　世の！　中ガッハッハアン！！　ア゛ーー世の中を！　ゥ変エダイ！　その一心でええ！！　ィヒーフーッハゥ。一生懸命訴えて、西宮市に、縁もゆかりもない西宮ッヘエ市民の皆さまに、選出されて！　やっと！　議員に！！　なったんですううー！！！ですから皆さまのご指摘を、県民の皆さまのご指摘と受け止めデーーヒィッフウ！！　ア゛ーハーア゛ァッハアァーー！　ッグ、ッグ、ア゛ーア゛ァアァアァ。ご指摘と受け止めて！　ア゛ーア゛ーッハア゛ーーン！　ご指摘と、受け止めて！　1人の大人として社会人として！　折り合いを付けましょうと！　そういう意味合いで、自分としては、「何で、実績に基づいてキッチリ報告してんのに、何で自分を曲げないといかんのや」と思いながらも！　もっと大きな、目標ォ！　すなわち！　本当に、少子高齢化を、自分の力で、議員1人のわずかな力ではありますけれども、解決したいと思っているからこそォォ！！　ご指摘の通り、平成26年度には195回行きました。301万円支出させていただきました。日帰りでございました！　そのご指摘を真摯に真剣に受け止めようとするから！　一人の大人として、何とか折り合いのつくところで折り合いを付けさせて頂いて、もっと大きな目標！　議員として、少子高齢化を、少しでも解決すべく、議員として活動させて頂きたいからこそ！　堪えに堪えて！　何とか折り合いのつくように！　……訂正・返納という形を事務局と相談させていただいて。ただ、議員個人じゃなくて、これは議会全体の問題に関わることかもしれないという、恐れがあるから、議員個人としての記者会見であり、議員個人としてお約束できる範囲で、しっかりとお約束させていただくと。ただ私自身も、議長に何回も何回も、選出されたいと願っておりましたけれども選出されず、やはり議会の、他の先生方のご意見も真摯に受け止めなければならない、そういうスタンスに立って、もう腹の中では堪えに堪えて、それで何とか、ご指摘は適正なもんだと認め、事務局と相談して、訂正・返納ということも踏まえて、議会で他の会派、議員の先生方との整合性をとらまえるということが、今ここの、私個人の記者会見としては、公の場としては、お約束しかねると！　そういう意味合いにおいて、何とかご指摘のことは本当に真摯に受け止めて、折り合いをつけさせて頂きたい。何故かといえば、議員というそういう大目標のなかに……。もちろん、政務調査費、政務活動費、ものすごい大事ですよ大事ですけれども！　議員というそういう大きい括りのなかでは、極々小さいものなんですゥ！　ですから！　いち、大人として、何とか、折り合いをつけさせて頂きたい。報道各位、記者の皆さまのご指摘は、適正なものだという形で真摯に理解して、何とか、訂正・返納ということを明言し、事務局と相談させて頂きたいと。ナ゛ッ！"));
